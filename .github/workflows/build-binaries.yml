name: Build Binaries

on:
  push:
    branches: [ master, main, automation001-202512 ]
  pull_request:
    branches: [ master, main, automation001-202512 ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Linux x64 Build
  build-linux-x64:
    runs-on: ubuntu-22.04
    name: Linux x64 Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          pkg-config \
          libusb-1.0-0-dev \
          qt6-base-dev \
          qt6-base-dev-tools \
          libqt6serialport6-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libxkbcommon-dev
    
    - name: Configure and Build
      run: |
        export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release -j$(nproc)
    
    - name: Verify Build Products
      run: |
        echo "=== Build Products ==="
        ls -la build/tools/DomesdayDuplicator/DomesdayDuplicator
        ls -la build/tools/dddconv/dddconv
        ls -la build/tools/dddutil/dddutil
    
    - name: Package Linux Build
      run: |
        mkdir -p artifacts/DomesdayDuplicator-Linux-x64
        cp build/tools/DomesdayDuplicator/DomesdayDuplicator artifacts/DomesdayDuplicator-Linux-x64/
        cp build/tools/dddconv/dddconv artifacts/DomesdayDuplicator-Linux-x64/
        cp build/tools/dddutil/dddutil artifacts/DomesdayDuplicator-Linux-x64/
        
        # Create simple install script
        cat > artifacts/DomesdayDuplicator-Linux-x64/install.sh << 'EOF'
        #!/bin/bash
        echo "DomesdayDuplicator Linux Installation"
        echo "====================================="
        echo "Prerequisites: libusb-1.0-0 qt6-base"
        echo "Install with: sudo apt install libusb-1.0-0 qt6-base qt6-serialport"
        echo ""
        echo "To run: ./DomesdayDuplicator"
        chmod +x DomesdayDuplicator dddconv dddutil
        EOF
        chmod +x artifacts/DomesdayDuplicator-Linux-x64/install.sh
        
        tar -czf DomesdayDuplicator-Linux-x64.tar.gz -C artifacts DomesdayDuplicator-Linux-x64
        ls -la DomesdayDuplicator-Linux-x64.tar.gz
    
    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DomesdayDuplicator-Linux-x64
        path: DomesdayDuplicator-Linux-x64.tar.gz
        retention-days: 30

  # Linux ARM64 Build
  build-linux-arm64:
    runs-on: ubuntu-22.04
    name: Linux ARM64 Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build ARM64 binaries in container
      run: |
        docker run --rm --platform=linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ubuntu:22.04 bash -c "
            apt update && apt install -y \
              build-essential cmake pkg-config \
              libusb-1.0-0-dev \
              qt6-base-dev qt6-base-dev-tools \
              libqt6serialport6-dev libgl1-mesa-dev \
              libglu1-mesa-dev libxkbcommon-dev
            
            export PKG_CONFIG_PATH='/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig'
            cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
            cmake --build build --config Release -j\$(nproc)
          "
    
    - name: Verify Build Products
      run: |
        echo "=== Build Products ==="
        file build/tools/DomesdayDuplicator/DomesdayDuplicator
        file build/tools/dddconv/dddconv
        file build/tools/dddutil/dddutil
        ls -la build/tools/DomesdayDuplicator/DomesdayDuplicator
        ls -la build/tools/dddconv/dddconv
        ls -la build/tools/dddutil/dddutil
    
    - name: Package Linux ARM64 Build
      run: |
        mkdir -p artifacts/DomesdayDuplicator-Linux-ARM64
        cp build/tools/DomesdayDuplicator/DomesdayDuplicator artifacts/DomesdayDuplicator-Linux-ARM64/
        cp build/tools/dddconv/dddconv artifacts/DomesdayDuplicator-Linux-ARM64/
        cp build/tools/dddutil/dddutil artifacts/DomesdayDuplicator-Linux-ARM64/
        
        # Create simple install script
        cat > artifacts/DomesdayDuplicator-Linux-ARM64/install.sh << 'EOF'
        #!/bin/bash
        echo "DomesdayDuplicator Linux ARM64 Installation"
        echo "=========================================="
        echo "Prerequisites: libusb-1.0-0 qt6-base"
        echo "Install with: sudo apt install libusb-1.0-0 qt6-base qt6-serialport"
        echo ""
        echo "To run: ./DomesdayDuplicator"
        chmod +x DomesdayDuplicator dddconv dddutil
        EOF
        chmod +x artifacts/DomesdayDuplicator-Linux-ARM64/install.sh
        
        tar -czf DomesdayDuplicator-Linux-ARM64.tar.gz -C artifacts DomesdayDuplicator-Linux-ARM64
        ls -la DomesdayDuplicator-Linux-ARM64.tar.gz
    
    - name: Upload Linux ARM64 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DomesdayDuplicator-Linux-ARM64
        path: DomesdayDuplicator-Linux-ARM64.tar.gz
        retention-days: 30

  # Windows x64 Build
  build-windows-x64:
    runs-on: windows-2022
    name: Windows x64 Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSYS2 (UCRT64)
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-make
          mingw-w64-ucrt-x86_64-pkg-config
          mingw-w64-ucrt-x86_64-libusb
          mingw-w64-ucrt-x86_64-qt6-base
          mingw-w64-ucrt-x86_64-qt6-tools
          mingw-w64-ucrt-x86_64-qt6-serialport
    
    - name: Build
      shell: msys2 {0}
      run: |
        export PKG_CONFIG_PATH="/ucrt64/lib/pkgconfig"
        export PATH="/ucrt64/bin:$PATH"
        
        # Create stub libonecoreuap to satisfy Qt6 linker requirement
        echo "LIBRARY onecoreuap" > /ucrt64/lib/libonecoreuap.def
        dlltool -d /ucrt64/lib/libonecoreuap.def -l /ucrt64/lib/libonecoreuap.a
        
        # Verify build tools
        which gcc && which g++ && ls /ucrt64/bin/*make*
        
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -G "MSYS Makefiles" -DCMAKE_MAKE_PROGRAM=/ucrt64/bin/mingw32-make.exe
        cmake --build build --config Release -j$(nproc)
    
    - name: Verify Windows Build
      shell: msys2 {0}
      run: |
        echo "=== Windows Build Products ==="
        ls -lh build/DomesdayDuplicator.exe
        ls -lh build/dddconv.exe
        ls -lh build/dddutil.exe
    
    - name: Package Windows Build
      shell: msys2 {0}
      run: |
        mkdir -p artifacts/DomesdayDuplicator-Windows-x64
        cp build/DomesdayDuplicator.exe artifacts/DomesdayDuplicator-Windows-x64/
        cp build/dddconv.exe artifacts/DomesdayDuplicator-Windows-x64/
        cp build/dddutil.exe artifacts/DomesdayDuplicator-Windows-x64/
        
        # Copy essential UCRT64 runtime DLLs
        for dll in libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll; do
          [ -f "/ucrt64/bin/$dll" ] && cp "/ucrt64/bin/$dll" artifacts/DomesdayDuplicator-Windows-x64/ || true
        done
        
        tar -czf DomesdayDuplicator-Windows-x64.tar.gz -C artifacts DomesdayDuplicator-Windows-x64
    
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DomesdayDuplicator-Windows-x64
        path: DomesdayDuplicator-Windows-x64.tar.gz
        retention-days: 30

  # macOS x64 Build (Intel)
  build-macos-x64:
    runs-on: macos-15-intel  # macOS 15 Intel runner (macos-13 retired)
    name: macOS x64 Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        # Fix cmake conflict
        brew uninstall cmake || true
        brew install cmake pkg-config libusb qt6
    
    - name: Build
      run: |
        export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig"
        export Qt6_DIR="$(brew --prefix qt6)/lib/cmake/Qt6"
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DQt6_DIR="$Qt6_DIR"
        cmake --build build --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Verify macOS Build
      run: |
        echo "=== macOS Build Products ==="
        ls -la build/tools/DomesdayDuplicator/ || echo "DomesdayDuplicator not found"
        ls -la build/tools/dddconv/dddconv || echo "dddconv not found"
        ls -la build/tools/dddutil/ || echo "dddutil not found"
    
    - name: Package macOS Build
      run: |
        mkdir -p artifacts/DomesdayDuplicator-macOS-x64
        
        # Copy DomesdayDuplicator (app bundle or binary)
        if [ -d "build/tools/DomesdayDuplicator/DomesdayDuplicator.app" ]; then
          echo "Packaging DomesdayDuplicator.app bundle"
          cp -R build/tools/DomesdayDuplicator/DomesdayDuplicator.app artifacts/DomesdayDuplicator-macOS-x64/
        elif [ -f "build/tools/DomesdayDuplicator/DomesdayDuplicator" ]; then
          echo "Packaging DomesdayDuplicator binary"
          cp build/tools/DomesdayDuplicator/DomesdayDuplicator artifacts/DomesdayDuplicator-macOS-x64/
        fi
        
        # Copy dddconv
        if [ -f "build/tools/dddconv/dddconv" ]; then
          cp build/tools/dddconv/dddconv artifacts/DomesdayDuplicator-macOS-x64/
        fi
        
        # Copy dddutil (app bundle or binary)
        if [ -d "build/tools/dddutil/dddutil.app" ]; then
          echo "Packaging dddutil.app bundle"
          cp -R build/tools/dddutil/dddutil.app artifacts/DomesdayDuplicator-macOS-x64/
        elif [ -f "build/tools/dddutil/dddutil" ]; then
          echo "Packaging dddutil binary"
          cp build/tools/dddutil/dddutil artifacts/DomesdayDuplicator-macOS-x64/
        fi
        
        tar -czf DomesdayDuplicator-macOS-x64.tar.gz -C artifacts DomesdayDuplicator-macOS-x64
    
    - name: Upload macOS x64 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DomesdayDuplicator-macOS-x64
        path: DomesdayDuplicator-macOS-x64.tar.gz
        retention-days: 30

  # macOS ARM64 Build (Apple Silicon)
  build-macos-arm64:
    runs-on: macos-latest  # macOS 15 Apple Silicon runner
    name: macOS ARM64 Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        # Fix cmake conflict
        brew uninstall cmake || true
        brew install cmake pkg-config libusb qt6
    
    - name: Build
      run: |
        export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig"
        export Qt6_DIR="$(brew --prefix qt6)/lib/cmake/Qt6"
        export LDFLAGS="-L$(brew --prefix)/lib"
        export CPPFLAGS="-I$(brew --prefix)/include"
        
        # Ensure ARM64 libraries are found
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release \
          -DQt6_DIR="$Qt6_DIR" \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_PREFIX_PATH="$(brew --prefix)" \
          -DCMAKE_LIBRARY_PATH="$(brew --prefix)/lib" \
          -DCMAKE_INCLUDE_PATH="$(brew --prefix)/include"
        cmake --build build --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Verify macOS ARM64 Build
      run: |
        echo "=== macOS ARM64 Build Products ==="
        file build/tools/DomesdayDuplicator/DomesdayDuplicator || file build/tools/DomesdayDuplicator/DomesdayDuplicator.app/Contents/MacOS/DomesdayDuplicator || echo "DomesdayDuplicator not found"
        file build/tools/dddconv/dddconv || echo "dddconv not found"
        file build/tools/dddutil/dddutil || file build/tools/dddutil/dddutil.app/Contents/MacOS/dddutil || echo "dddutil not found"
        ls -la build/tools/DomesdayDuplicator/ || echo "DomesdayDuplicator not found"
        ls -la build/tools/dddconv/dddconv || echo "dddconv not found"
        ls -la build/tools/dddutil/ || echo "dddutil not found"
    
    - name: Package macOS ARM64 Build
      run: |
        mkdir -p artifacts/DomesdayDuplicator-macOS-ARM64
        
        # Copy DomesdayDuplicator (app bundle or binary)
        if [ -d "build/tools/DomesdayDuplicator/DomesdayDuplicator.app" ]; then
          echo "Packaging DomesdayDuplicator.app bundle"
          cp -R build/tools/DomesdayDuplicator/DomesdayDuplicator.app artifacts/DomesdayDuplicator-macOS-ARM64/
        elif [ -f "build/tools/DomesdayDuplicator/DomesdayDuplicator" ]; then
          echo "Packaging DomesdayDuplicator binary"
          cp build/tools/DomesdayDuplicator/DomesdayDuplicator artifacts/DomesdayDuplicator-macOS-ARM64/
        fi
        
        # Copy dddconv
        if [ -f "build/tools/dddconv/dddconv" ]; then
          cp build/tools/dddconv/dddconv artifacts/DomesdayDuplicator-macOS-ARM64/
        fi
        
        # Copy dddutil (app bundle or binary)
        if [ -d "build/tools/dddutil/dddutil.app" ]; then
          echo "Packaging dddutil.app bundle"
          cp -R build/tools/dddutil/dddutil.app artifacts/DomesdayDuplicator-macOS-ARM64/
        elif [ -f "build/tools/dddutil/dddutil" ]; then
          echo "Packaging dddutil binary"
          cp build/tools/dddutil/dddutil artifacts/DomesdayDuplicator-macOS-ARM64/
        fi
        
        tar -czf DomesdayDuplicator-macOS-ARM64.tar.gz -C artifacts DomesdayDuplicator-macOS-ARM64
    
    - name: Upload macOS ARM64 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DomesdayDuplicator-macOS-ARM64
        path: DomesdayDuplicator-macOS-ARM64.tar.gz
        retention-days: 30
